parameters:
  pythonVersion: ""
  workingDirectory: ""
  uploadDirectory: ""
  fileExtension: ".*"
  targetWorkspaceId: ""
  targetLakehouseId: ""

variables:
  - group: azure-sp-creds
  - name: FABRIC_TENANT_ID
    value: $(ARM_TENANT_ID)
  - name: FABRIC_CLIENT_ID
    value: $(ARM_CLIENT_ID)
  - name: FABRIC_CLIENT_SECRET
    value: $(ARM_CLIENT_SECRET)

steps:
  - task: UsePythonVersion@0
    displayName: Set Python Version
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}
      addToPath: true

  - task: Bash@3
    displayName: "Install Poetry and Project"
    inputs:
      targetType: inline
      script: |
        pipx install poetry==2.1.3
        poetry install
      workingDirectory: "${{ parameters.workingDirectory }}"

  - task: Bash@3
    displayName: Upload to Lakehouse
    inputs:
      targetType: inline
      script: |
        poetry run fab config set encryption_fallback_enabled true
        poetry run fab auth login -u $FABRIC_CLIENT_ID -p $FABRIC_CLIENT_SECRET -t $FABRIC_TENANT_ID
        poetry run fab ls -l
        # WORKSPACE_NAME=$(fab ls -l | grep '01a4548b-b108-43ee-bd23-827469987426' | awk '{print $1}')
        # LAKEHOUSE_NAME=$(fab ls -l $WORKSPACE_NAME | grep '244c6cef-a02c-48fe-92ab-b3b9edd002b3' | awk '{print $1}')
        # fab cp example_spark_job.py $WORKSPACE_NAME/$LAKEHOUSE_NAME/Files
        # fab cp example_spark_job.py test-fabric-processing.Workspace/ProcessingLake.Lakehouse/Files
      workingDirectory: "${{ parameters.workingDirectory }}"
