parameters:
  pythonVersion: ""
  workingDirectory: "./"
  unitTestLocation: "./$(test_unit_src)"

steps:
  - task: UsePythonVersion@0
    displayName: Set Python Version
    inputs:
      versionSpec: ${{ parameters.pythonVersion }}
      addToPath: true

  - task: Bash@3
    displayName: "Create Poetry Environment and Install Packages"
    inputs:
      targetType: inline
      script: |
        pip install poetry
        poetry self add poetry-dotenv-plugin
        poetry install
      workingDirectory: "${{ parameters.workingDirectory }}"

  - task: Bash@3
    displayName: "Unit Tests"
    inputs:
      targetType: inline
      script: |
        poetry run pytest -rf -v "${{ parameters.unitTestLocation }}" --junitxml=test-results/unit-tests.xml
      workingDirectory: "${{ parameters.workingDirectory }}"
    env:
      UNIT_TEST_LOCATION: ${{ parameters.unitTestLocation }}

  - task: PublishTestResults@2
    displayName: "Publish Test Results"
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/test-results/unit-tests.xml'
      failTaskOnFailedTests: true
